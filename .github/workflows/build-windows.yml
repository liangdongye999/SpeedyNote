name: Build SpeedyNote EXE Packages

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build-exe:
    name: Build Windows EXE
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x86_64, arm64]
        include:
          - arch: x86_64
            msys_prefix: mingw-w64-clang-x86_64
            msystem: CLANG64
            build_args: ""
            runner: windows-latest
          - arch: arm64
            msys_prefix: mingw-w64-clang-x86_64
            msystem: CLANG64
            build_args: "-arm64"
            runner: windows-arm64
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: ${{ matrix.msystem }}
          update: true
          install: >
            ${{ matrix.msys_prefix }}-clang
            ${{ matrix.msys_prefix }}-lld
            ${{ matrix.msys_prefix }}-make
            ${{ matrix.msys_prefix }}-cmake
            ${{ matrix.msys_prefix }}-pkgconf
            ${{ matrix.msys_prefix }}-pkg-config
            ${{ matrix.msys_prefix }}-qt6-base
            ${{ matrix.msys_prefix }}-qt6-tools
            ${{ matrix.msys_prefix }}-qt6-translations
            ${{ matrix.msys_prefix }}-poppler
            ${{ matrix.msys_prefix }}-poppler-qt6
            ${{ matrix.msys_prefix }}-SDL2

      - name: Build
        timeout-minutes: 60
        run: |
          $ErrorActionPreference = "Stop"
          
          Write-Host "::group::Prepare build directory" -ForegroundColor Cyan
          if (Test-Path "build") { Remove-Item -Path "build" -Recurse -Force }
          New-Item -ItemType Directory -Path "build" | Out-Null
          
          # Compile translations
          $lreleaseExe = "D:\a\_temp\msys64\${{ matrix.msystem }}\bin\lrelease-qt6.exe"
          if (Test-Path $lreleaseExe) {
            Write-Host "Compiling translation files..." -ForegroundColor Green
            & $lreleaseExe ./resources/translations/app_zh.ts ./resources/translations/app_fr.ts ./resources/translations/app_es.ts
            Copy-Item -Path ".\resources\translations\*.qm" -Destination ".\build" -Force -ErrorAction SilentlyContinue
          } else {
            Write-Host "Warning: lrelease not found, skipping translations" -ForegroundColor Yellow
          }
          Write-Host "::endgroup::"
          
          Set-Location build
          
          # Setup environment - add MSYS2 to PATH
          $env:PATH = "D:\a\_temp\msys64\${{ matrix.msystem }}\bin;$env:PATH"
          
          Write-Host "::group::Configure CMake" -ForegroundColor Cyan
          $cmakeArgs = @(
            "-G", "MinGW Makefiles",
            "-DCMAKE_C_COMPILER=clang",
            "-DCMAKE_CXX_COMPILER=clang++",
            "-DCMAKE_MAKE_PROGRAM=mingw32-make",
            "-DCMAKE_BUILD_TYPE=Release"
          )
          
          if ("${{ matrix.arch }}" -eq "arm64") {
            $cmakeArgs += "-DCMAKE_SYSTEM_PROCESSOR=arm64"
          } else {
            $cmakeArgs += "-DCPU_ARCH=modern"
          }
          
          & cmake @cmakeArgs ..
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
          Write-Host "::endgroup::"
          
          Write-Host "::group::Build project" -ForegroundColor Cyan
          Write-Host "Building with single-threaded compilation to avoid memory issues..." -ForegroundColor Yellow
          & cmake --build . --config Release -- -j16
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
          Write-Host "::endgroup::"
          
          Write-Host "::group::Deploy Qt runtime" -ForegroundColor Cyan
          & windeployqt6 NoteApp.exe
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
          Write-Host "::endgroup::"
          
          Write-Host "::group::Copy dependencies" -ForegroundColor Cyan
          $sourceDir = "D:\a\_temp\msys64\${{ matrix.msystem }}\bin"
          
          # Copy required DLLs
          $dllPatterns = @(
            "libpoppler-*.dll", "libdeflate.dll", "libiconv-2.dll", "libnettle-8.dll",
            "libexpat-1.dll", "libicuin*.dll", "libicuuc*.dll", "libicudt*.dll",
            "libfreetype-6.dll", "libfontconfig-1.dll", "libglib-2.0-0.dll",
            "libintl-8.dll", "libpng16-16.dll", "libjpeg-8.dll", "libtiff-*.dll",
            "libopenjp2-*.dll", "liblcms2-2.dll", "libcrypto-3*.dll", "libssl-3*.dll",
            "libzstd.dll", "zlib1.dll", "libbz2-1.dll", "liblzma-5.dll",
            "libpoppler-qt6-*.dll", "SDL2.dll", "libharfbuzz-0.dll", "libgraphite2.dll",
            "libbrotlidec.dll", "libbrotlicommon.dll", "libpcre2-16-0.dll",
            "libgobject-2.0-0.dll", "libgcc_s_seh-1.dll", "libstdc++-6.dll",
            "libwinpthread-1.dll", "libc++.dll", "libunwind.dll"
          )
          
          $copiedCount = 0
          foreach ($pattern in $dllPatterns) {
            $files = Get-ChildItem -Path $sourceDir -Filter $pattern -ErrorAction SilentlyContinue
            foreach ($file in $files) {
              Copy-Item -Path $file.FullName -Destination . -Force -ErrorAction SilentlyContinue
              $copiedCount++
            }
          }
          Write-Host "Copied $copiedCount DLL files" -ForegroundColor Green
          
          # Copy share folder
          $shareSource = "D:\a\_temp\msys64\${{ matrix.msystem }}\share\poppler"
          if (Test-Path $shareSource) {
            New-Item -ItemType Directory -Path "share" -Force | Out-Null
            Copy-Item -Path $shareSource -Destination "share" -Recurse -Force
            Write-Host "Copied Poppler data files" -ForegroundColor Green
          }
          Write-Host "::endgroup::"
          
          Write-Host "Build completed successfully!" -ForegroundColor Green
          Get-Item NoteApp.exe | Format-List Name,Length,LastWriteTime
          
          Set-Location ..
        shell: pwsh

      - name: Upload EXE
        uses: actions/upload-artifact@v4
        with:
          name: speedynote-windows-package-${{ matrix.arch }}
          path: "build/*.exe"
